import express from 'express';
import VulnerabilityTest from '../models/VulnerabilityTest.js';
import scanner from '../services/scanner.js';
import { authenticate } from '../middleware/auth.js';

const router = express.Router();

/**
 * Run vulnerability tests on an endpoint
 */
router.post('/test', authenticate, async (req, res) => {
  try {
    const { url, method, headers, body, authType, authConfig } = req.body;

    if (!url) {
      return res.status(400).json({ error: 'URL is required' });
    }

    // Trim whitespace
    const trimmedUrl = url.trim();

    // Basic URL validation
    if (!trimmedUrl.startsWith('http://') && !trimmedUrl.startsWith('https://')) {
      return res.status(400).json({ 
        error: 'Invalid URL format. URL must start with http:// or https://' 
      });
    }

    // Run the scan
    const scanResults = await scanner.scanEndpoint({
      url: trimmedUrl,
      method: method || 'GET',
      headers: headers || {},
      body,
      authType: authType || 'none',
      authConfig: authConfig || {}
    });

    res.json({
      success: true,
      results: scanResults
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

/**
 * Get vulnerability test history
 */
router.get('/history', authenticate, async (req, res) => {
  try {
    const { limit = 50, testType, status, severity } = req.query;

    const query = { userId: req.user._id };
    
    if (testType) query.testType = testType;
    if (status) query.status = status;
    if (severity) query.severity = severity;

    const tests = await VulnerabilityTest.find(query)
      .sort({ createdAt: -1 })
      .limit(parseInt(limit));

    res.json({ tests });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

/**
 * Get vulnerability statistics
 */
router.get('/stats', authenticate, async (req, res) => {
  try {
    const stats = await VulnerabilityTest.aggregate([
      { $match: { userId: req.user._id } },
      {
        $group: {
          _id: '$testType',
          total: { $sum: 1 },
          passed: {
            $sum: { $cond: [{ $eq: ['$status', 'passed'] }, 1, 0] }
          },
          failed: {
            $sum: { $cond: [{ $eq: ['$status', 'failed'] }, 1, 0] }
          },
          critical: {
            $sum: { $cond: [{ $eq: ['$severity', 'critical'] }, 1, 0] }
          },
          high: {
            $sum: { $cond: [{ $eq: ['$severity', 'high'] }, 1, 0] }
          },
          medium: {
            $sum: { $cond: [{ $eq: ['$severity', 'medium'] }, 1, 0] }
          },
          low: {
            $sum: { $cond: [{ $eq: ['$severity', 'low'] }, 1, 0] }
          }
        }
      }
    ]);

    res.json({ stats });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

export default router;
